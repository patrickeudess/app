<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Tableau de Bord Professionnel - Mon Cacao</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/modern-banner.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .professional-dashboard {
            padding: 2rem 0;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .dashboard-header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
        }

        .dashboard-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-card .stat-icon.producers {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-card .stat-icon.production {
            background: linear-gradient(135deg, #2E8B57, #3CB371);
        }

        .stat-card .stat-icon.revenue {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .stat-card .stat-icon.performance {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        /* Styles pour la grille de fonctionnalités */
        .features-section {
            margin-top: 2rem;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.2rem;
            margin: 1.5rem 0;
        }

        .feature-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid transparent;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: #667eea;
        }

        .feature-card:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }

        .feature-card .feature-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .feature-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 0.5rem 0;
        }

        .feature-card p {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0;
        }

        .feature-card .feature-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #FFD700;
            color: #2c3e50;
        }

        .stat-card h3 {
            margin: 0 0 0.5rem 0;
            color: #2c3e50;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        .producers-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .producers-section h2 {
            margin: 0 0 1.5rem 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .producers-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .producer-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .producer-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
        }

        .producer-card h3 {
            margin: 0 0 0.5rem 0;
            color: #2c3e50;
        }

        .producer-card .producer-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
        }

        .actions-section {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: white;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #2E8B57, #3CB371);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        /* Styles pour le modal */
        .producer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #dc3545;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body .form-group {
            margin-bottom: 1.5rem;
        }

        .modal-body label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-body input,
        .modal-body select,
        .modal-body textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .modal-body input:focus,
        .modal-body select:focus,
        .modal-body textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 2px solid #e9ecef;
        }

        .btn-cancel,
        .btn-submit {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        
        /* Tablettes (768px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .producers-list {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .dashboard-header {
                padding: 1.5rem;
            }

            .dashboard-header h1 {
                font-size: 1.75rem;
            }
        }

        /* Tablettes et petits écrans (max-width: 768px) */
        @media (max-width: 768px) {
            .professional-dashboard {
                padding: 1rem 0;
            }

            .dashboard-header {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .dashboard-header h1 {
                font-size: 1.5rem;
            }

            .dashboard-header p {
                font-size: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .stat-card {
                padding: 1.25rem;
            }

            .stat-card .stat-icon {
                width: 45px;
                height: 45px;
                font-size: 1.25rem;
            }

            .stat-card .stat-value {
                font-size: 1.75rem;
            }

            .producers-section {
                padding: 1.5rem;
            }

            .producers-section h2 {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }

            .producers-list {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .producer-card {
                padding: 1.25rem;
            }

            .producer-card h3 {
                font-size: 1.1rem;
            }

            .producer-card .producer-info {
                font-size: 0.85rem;
            }

            .charts-section {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .chart-card {
                padding: 1.25rem;
            }

            .chart-card h3 {
                font-size: 1.1rem;
            }

            .actions-section {
                flex-direction: column;
                gap: 0.75rem;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
                padding: 0.875rem 1.5rem;
                font-size: 0.95rem;
            }

            .modal-content {
                width: 95%;
                max-height: 95vh;
                margin: 1rem;
            }

            .modal-header {
                padding: 1.25rem;
            }

            .modal-header h2 {
                font-size: 1.25rem;
            }

            .modal-body {
                padding: 1.25rem;
            }
        }

        /* Smartphones (max-width: 480px) */
        @media (max-width: 480px) {
            .professional-dashboard {
                padding: 0.5rem 0;
            }

            .content-container {
                padding: 0.75rem;
            }

            .dashboard-header {
                padding: 1.25rem;
                border-radius: 12px;
            }

            .dashboard-header h1 {
                font-size: 1.25rem;
                margin-bottom: 0.5rem;
            }

            .dashboard-header p {
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                margin-bottom: 1.5rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-card .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
            }

            .stat-card h3 {
                font-size: 0.85rem;
                margin-bottom: 0.375rem;
            }

            .stat-card .stat-value {
                font-size: 1.5rem;
            }

            .producers-section {
                padding: 1rem;
                border-radius: 12px;
            }

            .producers-section > div:first-child {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .producers-section h2 {
                font-size: 1.1rem;
                margin: 0;
            }

            .producers-section .action-btn {
                width: 100%;
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }

            .producers-list {
                gap: 0.5rem;
            }

            .producer-card {
                padding: 1rem;
                border-radius: 10px;
            }

            .producer-card h3 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            .producer-card .producer-info {
                font-size: 0.8rem;
                gap: 0.375rem;
            }

            .producer-card .producer-info span {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .charts-section {
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .chart-card {
                padding: 1rem;
                border-radius: 12px;
            }

            .chart-card h3 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            .actions-section {
                gap: 0.5rem;
            }

            .action-btn {
                padding: 0.875rem 1.25rem;
                font-size: 0.9rem;
                border-radius: 10px;
            }

            .action-btn i {
                font-size: 0.9rem;
            }

            /* Header responsive */
            .header-content {
                flex-wrap: wrap;
                gap: 0.75rem;
            }

            .header-left {
                flex: 1;
                min-width: 0;
            }

            .header-right {
                width: 100%;
                justify-content: flex-end;
            }

            .btn-disconnect {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            .btn-disconnect span {
                display: none;
            }

            /* Modal responsive */
            .modal-content {
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
            }

            .modal-header {
                padding: 1rem;
            }

            .modal-header h2 {
                font-size: 1.1rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-body .form-group {
                margin-bottom: 1.25rem;
            }

            .modal-body label {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }

            .modal-body input,
            .modal-body select,
            .modal-body textarea {
                padding: 0.625rem;
                font-size: 0.95rem;
            }

            .modal-actions {
                padding: 1rem;
                flex-direction: column;
            }

            .btn-cancel,
            .btn-submit {
                width: 100%;
                padding: 0.875rem 1.25rem;
                font-size: 0.95rem;
                justify-content: center;
            }
        }

        /* Très petits écrans (max-width: 360px) */
        @media (max-width: 360px) {
            .dashboard-header h1 {
                font-size: 1.1rem;
            }

            .stat-card .stat-value {
                font-size: 1.25rem;
            }

            .producer-card {
                padding: 0.875rem;
            }

            .action-btn {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }
        }

        /* Orientation paysage sur mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                max-height: 90vh;
            }
        }

        /* Touch-friendly pour mobile */
        @media (hover: none) and (pointer: coarse) {
            .producer-card:hover {
                transform: none;
            }

            .producer-card:active {
                transform: scale(0.98);
                background: #f8f9fa;
            }

            .action-btn:hover {
                transform: none;
            }

            .action-btn:active {
                transform: scale(0.98);
            }

            /* Augmenter la taille des zones cliquables */
            .producer-card {
                min-height: 80px;
            }

            .action-btn {
                min-height: 44px;
            }

            .btn-cancel,
            .btn-submit {
                min-height: 44px;
            }

            /* Masquer le texte des boutons sur très petits écrans */
            .btn-text {
                display: inline;
            }
        }

        /* Masquer le texte des boutons sur mobile */
        @media (max-width: 480px) {
            .action-btn .btn-text {
                display: none;
            }

            .action-btn {
                padding: 0.75rem;
                min-width: 44px;
            }

            .producers-header .action-btn .btn-text {
                display: inline;
            }

            .producers-header .action-btn {
                width: 100%;
                justify-content: center;
            }

            .features-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }

            .feature-card {
                padding: 1rem;
                min-height: 120px;
            }

            .feature-card .feature-icon {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }

            .feature-card h3 {
                font-size: 1rem;
            }

            .feature-card p {
                font-size: 0.85rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }

        /* Amélioration pour iOS Safari */
        @supports (-webkit-touch-callout: none) {
            .modal-content {
                -webkit-overflow-scrolling: touch;
            }

            .producers-list {
                -webkit-overflow-scrolling: touch;
            }

            /* Fix pour le header sur iOS */
            .app-header {
                position: -webkit-sticky;
                position: sticky;
                top: 0;
            }
        }

        /* Amélioration du header pour mobile */
        @media (max-width: 768px) {
            .app-header {
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            .header-content {
                padding: 0.75rem 1rem;
            }

            .header-logo .logo-text h1 {
                font-size: 1.1rem;
            }

            .user-status {
                font-size: 0.85rem;
            }

            .user-info span {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                padding: 0.5rem 0.75rem;
            }

            .header-logo {
                flex-direction: row;
                align-items: center;
            }

            .logo-container {
                width: 40px !important;
                height: 40px !important;
            }

            .logo-plant {
                font-size: 1.2rem !important;
            }

            .logo-coins {
                font-size: 1rem !important;
            }

            .header-logo .logo-text h1 {
                font-size: 1rem;
                margin-left: 0.5rem;
            }

            .user-status {
                flex-direction: column;
                gap: 0.25rem;
                font-size: 0.75rem;
            }

            .status-line,
            .user-info {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header harmonisé -->
    <header class="app-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-logo">
                    <div class="logo-container">
                        <i class="fas fa-seedling logo-plant"></i>
                        <i class="fas fa-coins logo-coins"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Mon Cacao</h1>
                    </div>
                </div>
                <div class="user-status">
                    <div class="status-line">
                        <i class="fas fa-circle status-dot"></i>
                        <span>En ligne</span>
                    </div>
                    <div class="user-info">
                        <i class="fas fa-building user-icon"></i>
                        <span>Professionnel</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="btn-disconnect" onclick="changeUserType()">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Changer de profil</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Tableau de bord professionnel en mode carte -->
    <main class="main-content professional-dashboard">
        <div class="content-container">
            <!-- En-tête du tableau de bord -->
            <div class="section-header" style="margin-bottom: 2rem;">
                <h1 class="section-title">
                    <i class="fas fa-building"></i>
                    Tableau de Bord Professionnel
                </h1>
                <p class="section-subtitle" style="color: #6c757d; margin-top: 0.5rem;">Gérez et suivez les performances de vos producteurs</p>
            </div>

            <!-- Statistiques rapides en cartes -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-icon producers">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Producteurs</h3>
                    <p class="stat-value" id="totalProducers">0</p>
                </div>

                <div class="stat-card">
                    <div class="stat-icon production">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <h3>Production</h3>
                    <p class="stat-value" id="totalProduction">0</p>
                    <small style="color: #6c757d;">kg</small>
                </div>

                <div class="stat-card">
                    <div class="stat-icon revenue">
                        <i class="fas fa-coins"></i>
                    </div>
                    <h3>Revenus</h3>
                    <p class="stat-value" id="totalRevenue">0</p>
                    <small style="color: #6c757d;">FCFA</small>
                </div>

                <div class="stat-card">
                    <div class="stat-icon performance">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>Performance</h3>
                    <p class="stat-value" id="avgPerformance">0</p>
                    <small style="color: #6c757d;">%</small>
                </div>
            </div>

            <!-- Grille de fonctionnalités en mode carte -->
            <div class="features-section">
                <div class="section-header">
                    <h2 class="section-title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">
                        <i class="fas fa-th"></i>
                        Fonctionnalités
                    </h2>
                </div>
                
                <div class="features-grid">
                    <!-- Mes Producteurs -->
                    <div class="feature-card" onclick="window.location.href='mes-producteurs.html'">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Mes Producteurs</h3>
                        <p>Gérer vos producteurs</p>
                        <div class="feature-badge" id="producersBadge" style="display: none;">0</div>
                    </div>

                    <!-- Estimation de Production -->
                    <div class="feature-card" onclick="window.location.href='estimation-production.html'">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #2E8B57, #3CB371);">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h3>Estimation</h3>
                        <p>Prévisions de production</p>
                        <div class="feature-badge">IA</div>
                    </div>

                    <!-- Analyse des Conseils -->
                    <div class="feature-card" onclick="window.location.href='analyse-conseils.html'">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #FFD700, #FFA500);">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <h3>Conseils</h3>
                        <p>Analyse des conseils donnés</p>
                    </div>

                    <!-- Statistiques -->
                    <div class="feature-card" onclick="window.location.href='statistiques.html'">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #28a745, #20c997);">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3>Statistiques</h3>
                        <p>Vue d'ensemble des données</p>
                    </div>

                    <!-- Graphiques -->
                    <div class="feature-card" onclick="window.location.href='graphiques.html'">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h3>Graphiques</h3>
                        <p>Visualisations et tendances</p>
                    </div>

                    <!-- Rapports -->
                    <div class="feature-card" onclick="window.location.href='rapports.html'">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h3>Rapports</h3>
                        <p>Exporter les données</p>
                    </div>

                    <!-- Messagerie -->
                    <div class="feature-card" onclick="window.location.href='messagerie.html'">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3>Messagerie</h3>
                        <p>Communiquer avec vos producteurs</p>
                        <div class="feature-badge" id="messagesBadge" style="display: none;">0</div>
                    </div>

                    <!-- Cartographie -->
                    <div class="feature-card" onclick="window.location.href='cartographie.html'">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #2E8B57, #228B22);">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <h3>Cartographie</h3>
                        <p>Visualiser les plantations</p>
                    </div>

                    <!-- Gamification -->
                    <div class="feature-card" onclick="window.location.href='gamification.html'">
                        <div class="feature-icon" style="background: linear-gradient(135deg, #FFD700, #FFA500);">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h3>Gamification</h3>
                        <p>Badges, points et classements</p>
                    </div>
                </div>
            </div>

            <!-- Section Producteurs (cachée par défaut) -->
            <div id="producersSection" style="display: none; margin-top: 2rem;">
                <div class="section-header" style="margin-bottom: 1.5rem;">
                    <h2 class="section-title" style="font-size: 1.5rem;">
                        <i class="fas fa-users"></i>
                        Mes Producteurs
                    </h2>
                    <button class="action-btn primary" onclick="addProducer()" style="padding: 0.75rem 1.5rem;">
                        <i class="fas fa-plus"></i>
                        Ajouter un producteur
                    </button>
                </div>
                <div class="producers-list" id="producersList">
                    <!-- Les producteurs seront chargés dynamiquement -->
                </div>
            </div>

            <!-- Section Estimation (cachée par défaut) -->
            <div id="estimationSection" style="display: none; margin-top: 2rem;">
                <div class="section-header" style="margin-bottom: 1.5rem;">
                    <h2 class="section-title" style="font-size: 1.5rem;">
                        <i class="fas fa-calculator"></i>
                        Estimation de Production
                    </h2>
                    <button class="action-btn secondary" onclick="calculateProductionEstimates()" id="estimateBtn">
                        <i class="fas fa-calculator"></i>
                        <span class="btn-text">Calculer</span>
                    </button>
                </div>
                <div id="productionEstimates">
                    <!-- Les estimations seront chargées ici -->
                </div>
                <div id="estimatesPlaceholder" style="text-align: center; padding: 2rem; color: #6c757d;">
                    <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Cliquez sur "Calculer" pour obtenir des prévisions de production basées sur les données de vos producteurs.</p>
                </div>
            </div>

            <!-- Section Analyse des Conseils (cachée par défaut) -->
            <div id="adviceAnalysisSection" style="display: none; margin-top: 2rem;">
                <div class="section-header" style="margin-bottom: 1.5rem;">
                    <h2 class="section-title" style="font-size: 1.5rem;">
                        <i class="fas fa-lightbulb"></i>
                        Analyse des Conseils Donnés
                    </h2>
                    <button class="action-btn secondary" onclick="loadAdviceAnalysis()" id="adviceAnalysisBtn">
                        <i class="fas fa-chart-bar"></i>
                        <span class="btn-text">Analyser</span>
                    </button>
                </div>
                <div id="adviceAnalysis" style="display: none;">
                    <!-- L'analyse sera chargée ici -->
                </div>
                <div id="advicePlaceholder" style="text-align: center; padding: 2rem; color: #6c757d;">
                    <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Cliquez sur "Analyser" pour voir quels conseils sont le plus souvent consultés par vos producteurs.</p>
                </div>
            </div>

            <!-- Section Statistiques (cachée par défaut) -->
            <div id="statisticsSection" style="display: none; margin-top: 2rem;">
                <div class="section-header" style="margin-bottom: 1.5rem;">
                    <h2 class="section-title" style="font-size: 1.5rem;">
                        <i class="fas fa-chart-bar"></i>
                        Statistiques Détaillées
                    </h2>
                </div>
                <div id="detailedStatistics">
                    <!-- Les statistiques détaillées seront chargées ici -->
                </div>
            </div>

            <!-- Section Graphiques (cachée par défaut) -->
            <div id="chartsSection" style="display: none; margin-top: 2rem;">
                <div class="section-header" style="margin-bottom: 1.5rem;">
                    <h2 class="section-title" style="font-size: 1.5rem;">
                        <i class="fas fa-chart-pie"></i>
                        Graphiques et Visualisations
                    </h2>
                </div>
                <div class="charts-section">
                    <div class="chart-card">
                        <h3>Évolution de la Production</h3>
                        <canvas id="productionChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Répartition par Région</h3>
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Vérifier l'authentification et le type d'utilisateur au chargement
        document.addEventListener('DOMContentLoaded', function() {
            const userAuthenticated = localStorage.getItem('user_authenticated');
            const userType = localStorage.getItem('user_type');
            const userTypeSelected = localStorage.getItem('user_type_selected');
            
            // Vérifier l'authentification
            if (!userAuthenticated || userAuthenticated !== 'true') {
                // Si pas authentifié, rediriger vers la sélection du type
                window.location.href = 'user-type-selection.html';
                return;
            }
            
            // Si aucun type n'est sélectionné ou si c'est un producteur, rediriger
            if (!userTypeSelected || userType !== 'professionnel') {
                if (userType === 'producteur') {
                    window.location.href = 'index.html';
                    return;
                }
                // Sinon, rediriger vers la page de sélection
                window.location.href = 'user-type-selection.html';
                return;
            }

            // Charger les données du tableau de bord
            loadDashboardData();
            // Ne pas initialiser les graphiques par défaut (seront chargés quand la section sera affichée)
        });

        function changeUserType() {
            if (confirm('Voulez-vous changer de profil ? Vous serez déconnecté.')) {
                // Déconnecter l'utilisateur
                localStorage.removeItem('user_type');
                localStorage.removeItem('user_type_selected');
                localStorage.removeItem('user_authenticated');
                localStorage.removeItem('current_user_id');
                localStorage.removeItem('current_user_name');
                localStorage.removeItem('selected_user_type_for_auth');
                window.location.href = 'user-type-selection.html';
            }
        }

        // Fonctions pour afficher/masquer les sections
        function showProducersSection() {
            hideAllSections();
            document.getElementById('producersSection').style.display = 'block';
            loadDashboardData();
        }

        function showEstimationSection() {
            hideAllSections();
            document.getElementById('estimationSection').style.display = 'block';
        }

        function showAdviceAnalysisSection() {
            hideAllSections();
            document.getElementById('adviceAnalysisSection').style.display = 'block';
        }

        function showStatisticsSection() {
            hideAllSections();
            document.getElementById('statisticsSection').style.display = 'block';
            loadDetailedStatistics();
        }

        function showChartsSection() {
            hideAllSections();
            document.getElementById('chartsSection').style.display = 'block';
            initializeCharts();
        }

        function hideAllSections() {
            document.getElementById('producersSection').style.display = 'none';
            document.getElementById('estimationSection').style.display = 'none';
            document.getElementById('adviceAnalysisSection').style.display = 'none';
            document.getElementById('statisticsSection').style.display = 'none';
            document.getElementById('chartsSection').style.display = 'none';
        }

        function loadDashboardData() {
            // Récupérer les producteurs créés par le professionnel
            const professionalProducers = JSON.parse(localStorage.getItem('professional_producers')) || [];
            
            // Récupérer toutes les données soumises par les producteurs
            const allProducerData = JSON.parse(localStorage.getItem('all_producer_submissions')) || {};
            
            // Calculer les statistiques à partir des données réelles
            let totalProduction = 0;
            let totalRevenue = 0;
            let totalSubmissions = 0;
            const producersWithData = [];

            professionalProducers.forEach(producer => {
                const producerSubmissions = allProducerData[producer.id] || [];
                let producerProduction = 0;
                let producerRevenue = 0;

                producerSubmissions.forEach(submission => {
                    if (submission.production_reelle) {
                        producerProduction += parseFloat(submission.production_reelle) || 0;
                    }
                    if (submission.revenu_total) {
                        producerRevenue += parseFloat(submission.revenu_total) || 0;
                    }
                    totalSubmissions++;
                });

                totalProduction += producerProduction;
                totalRevenue += producerRevenue;

                if (producerSubmissions.length > 0) {
                    producersWithData.push({
                        ...producer,
                        production: producerProduction,
                        revenue: producerRevenue,
                        submissionsCount: producerSubmissions.length,
                        lastSubmission: producerSubmissions[producerSubmissions.length - 1]?.date_soumission || ''
                    });
                } else {
                    // Afficher même les producteurs sans données
                    producersWithData.push({
                        ...producer,
                        production: 0,
                        revenue: 0,
                        submissionsCount: 0,
                        lastSubmission: ''
                    });
                }
            });

            // Calculer la performance moyenne (basée sur le ratio production/coût)
            const avgPerformance = professionalProducers.length > 0 && totalProduction > 0 
                ? Math.round((totalProduction / (totalProduction + (totalRevenue / 1000))) * 100) 
                : 0;

            // Mettre à jour les statistiques
            document.getElementById('totalProducers').textContent = professionalProducers.length;
            document.getElementById('totalProduction').textContent = totalProduction.toLocaleString();
            document.getElementById('totalRevenue').textContent = totalRevenue > 1000000 
                ? (totalRevenue / 1000000).toFixed(1) + 'M' 
                : totalRevenue.toLocaleString();
            document.getElementById('avgPerformance').textContent = avgPerformance;

            // Mettre à jour le badge des producteurs
            const producersBadge = document.getElementById('producersBadge');
            if (producersBadge) {
                if (professionalProducers.length > 0) {
                    producersBadge.textContent = professionalProducers.length;
                    producersBadge.style.display = 'block';
                } else {
                    producersBadge.style.display = 'none';
                }
            }

            // Afficher les producteurs dans la section dédiée
            const producersList = document.getElementById('producersList');
            if (!producersList) return;
            let producersHTML = '';
            
            if (producersWithData.length > 0) {
                // Afficher tous les producteurs
                producersHTML = producersWithData.map(producer => `
                    <div class="producer-card" onclick="viewProducer('${producer.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <h3>${producer.name}</h3>
                            ${producer.submissionsCount > 0 ? `<span style="background: #2E8B57; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">${producer.submissionsCount} soumission${producer.submissionsCount > 1 ? 's' : ''}</span>` : '<span style="color: #6c757d; font-size: 0.75rem;">Aucune donnée</span>'}
                        </div>
                        <div class="producer-info">
                            <span><i class="fas fa-map-marker-alt"></i> ${producer.region}</span>
                            ${producer.code ? `<span style="font-size: 0.8rem; color: #667eea;"><i class="fas fa-key"></i> Code: ${producer.code}</span>` : ''}
                            ${producer.production > 0 ? `<span><i class="fas fa-seedling"></i> ${producer.production.toLocaleString()} kg</span>` : ''}
                            ${producer.revenue > 0 ? `<span><i class="fas fa-coins"></i> ${producer.revenue.toLocaleString()} FCFA</span>` : ''}
                            ${producer.lastSubmission ? `<span style="font-size: 0.8rem; color: #6c757d;"><i class="fas fa-calendar"></i> Dernière soumission: ${new Date(producer.lastSubmission).toLocaleDateString('fr-FR')}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            // Toujours afficher le bouton "Ajouter un producteur" à la fin
            producersHTML += `
                <div class="producer-card" style="text-align: center; padding: 2rem; border: 2px dashed #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05)); cursor: pointer;" onclick="addProducer()">
                    <i class="fas fa-user-plus" style="font-size: 2.5rem; color: #667eea; margin-bottom: 1rem;"></i>
                    <h3 style="color: #667eea; margin-bottom: 0.5rem;">Ajouter un producteur</h3>
                    <p style="color: #6c757d; font-size: 0.9rem;">Cliquez pour ajouter un nouveau producteur à votre liste</p>
                </div>
            `;
            
            producersList.innerHTML = producersHTML;
        }

        function loadDetailedStatistics() {
            const statsDiv = document.getElementById('detailedStatistics');
            if (!statsDiv) return;

            const professionalProducers = JSON.parse(localStorage.getItem('professional_producers')) || [];
            const allProducerData = JSON.parse(localStorage.getItem('all_producer_submissions')) || {};
            
            let totalProduction = 0;
            let totalRevenue = 0;
            let totalCost = 0;
            let totalSubmissions = 0;
            const regionStats = {};

            professionalProducers.forEach(producer => {
                const submissions = allProducerData[producer.id] || [];
                submissions.forEach(sub => {
                    if (sub.production_reelle) totalProduction += parseFloat(sub.production_reelle) || 0;
                    if (sub.revenu_total) totalRevenue += parseFloat(sub.revenu_total) || 0;
                    if (sub.cout_prod) totalCost += parseFloat(sub.cout_prod) || 0;
                    totalSubmissions++;
                    
                    if (sub.region) {
                        regionStats[sub.region] = (regionStats[sub.region] || 0) + 1;
                    }
                });
            });

            const avgProduction = professionalProducers.length > 0 ? totalProduction / professionalProducers.length : 0;
            const avgRevenue = professionalProducers.length > 0 ? totalRevenue / professionalProducers.length : 0;
            const profit = totalRevenue - totalCost;

            statsDiv.innerHTML = `
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-icon production">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <h3>Production totale</h3>
                        <p class="stat-value">${totalProduction.toLocaleString()}</p>
                        <small>kg</small>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue">
                            <i class="fas fa-coins"></i>
                        </div>
                        <h3>Revenus totaux</h3>
                        <p class="stat-value">${totalRevenue > 1000000 ? (totalRevenue / 1000000).toFixed(1) + 'M' : totalRevenue.toLocaleString()}</p>
                        <small>FCFA</small>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <h3>Coûts totaux</h3>
                        <p class="stat-value">${totalCost > 1000000 ? (totalCost / 1000000).toFixed(1) + 'M' : totalCost.toLocaleString()}</p>
                        <small>FCFA</small>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #28a745, #20c997);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Bénéfice net</h3>
                        <p class="stat-value">${profit > 1000000 ? (profit / 1000000).toFixed(1) + 'M' : profit.toLocaleString()}</p>
                        <small>FCFA</small>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h3>Soumissions</h3>
                        <p class="stat-value">${totalSubmissions}</p>
                        <small>total</small>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107, #ff9800);">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h3>Moyenne/prod.</h3>
                        <p class="stat-value">${Math.round(avgProduction)}</p>
                        <small>kg</small>
                    </div>
                </div>
            `;
        }

        function initializeCharts() {
            // Vérifier que les canvas existent
            const productionCanvas = document.getElementById('productionChart');
            const regionCanvas = document.getElementById('regionChart');
            
            if (!productionCanvas || !regionCanvas) {
                console.log('Les canvas de graphiques ne sont pas encore disponibles');
                return;
            }

            // Détruire les graphiques existants s'ils existent
            if (window.productionChartInstance) {
                window.productionChartInstance.destroy();
            }
            if (window.regionChartInstance) {
                window.regionChartInstance.destroy();
            }

            // Récupérer les données réelles
            const professionalProducers = JSON.parse(localStorage.getItem('professional_producers')) || [];
            const allProducerData = JSON.parse(localStorage.getItem('all_producer_submissions')) || {};
            
            // Calculer les données pour les graphiques
            const monthlyData = {};
            const regionData = {};

            professionalProducers.forEach(producer => {
                const submissions = allProducerData[producer.id] || [];
                submissions.forEach(sub => {
                    if (sub.date_soumission) {
                        const date = new Date(sub.date_soumission);
                        const month = date.toLocaleDateString('fr-FR', { month: 'short' });
                        monthlyData[month] = (monthlyData[month] || 0) + (parseFloat(sub.production_reelle) || 0);
                    }
                    if (sub.region) {
                        regionData[sub.region] = (regionData[sub.region] || 0) + 1;
                    }
                });
            });

            // Graphique de production
            const productionCtx = productionCanvas.getContext('2d');
            window.productionChartInstance = new Chart(productionCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(monthlyData).length > 0 ? Object.keys(monthlyData) : ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'Production (kg)',
                        data: Object.keys(monthlyData).length > 0 ? Object.values(monthlyData) : [1200, 1900, 3000, 2500, 2200, 3000],
                        borderColor: '#2E8B57',
                        backgroundColor: 'rgba(46, 139, 87, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });

            // Graphique par région
            const regionCtx = regionCanvas.getContext('2d');
            const regionLabels = Object.keys(regionData).length > 0 ? Object.keys(regionData) : ['Abidjan', 'Yamoussoukro', 'Bouaké', 'Autres'];
            const regionValues = Object.keys(regionData).length > 0 ? Object.values(regionData) : [35, 28, 22, 15];
            
            window.regionChartInstance = new Chart(regionCtx, {
                type: 'doughnut',
                data: {
                    labels: regionLabels,
                    datasets: [{
                        data: regionValues,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#2E8B57',
                            '#FFD700',
                            '#ffc107',
                            '#17a2b8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        // Modal pour ajouter un producteur
        function addProducer() {
            const modal = document.getElementById('addProducerModal');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                createAddProducerModal();
            }
        }

        function createAddProducerModal() {
            const modal = document.createElement('div');
            modal.id = 'addProducerModal';
            modal.className = 'producer-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>
                            <i class="fas fa-user-plus"></i>
                            Ajouter un nouveau producteur
                        </h2>
                        <button class="modal-close" onclick="closeProducerModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addProducerForm" onsubmit="saveProducer(event)">
                            <div class="form-group">
                                <label for="producerName">
                                    <i class="fas fa-user"></i>
                                    Nom complet du producteur *
                                </label>
                                <input type="text" id="producerName" required placeholder="Ex: Kouassi Jean">
                            </div>
                            <div class="form-group">
                                <label for="producerRegion">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Région *
                                </label>
                                <select id="producerRegion" required>
                                    <option value="">Sélectionner une région</option>
                                    <option value="Indenie-Djuablin">Indenie-Djuablin</option>
                                    <option value="Yamoussoukro">Yamoussoukro</option>
                                    <option value="La Me">La Me</option>
                                    <option value="San-Pedro">San-Pedro</option>
                                    <option value="Grand-Ponts">Grand-Ponts</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="producerPhone">
                                    <i class="fas fa-phone"></i>
                                    Téléphone (optionnel)
                                </label>
                                <input type="tel" id="producerPhone" placeholder="Ex: +225 07 12 34 56 78">
                            </div>
                            <div class="form-group">
                                <label for="producerEmail">
                                    <i class="fas fa-envelope"></i>
                                    Email (optionnel)
                                </label>
                                <input type="email" id="producerEmail" placeholder="Ex: producteur@example.com">
                            </div>
                            <div class="form-group">
                                <label for="producerNotes">
                                    <i class="fas fa-sticky-note"></i>
                                    Notes (optionnel)
                                </label>
                                <textarea id="producerNotes" rows="3" placeholder="Informations supplémentaires sur le producteur..."></textarea>
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn-cancel" onclick="closeProducerModal()">
                                    <i class="fas fa-times"></i>
                                    Annuler
                                </button>
                                <button type="submit" class="btn-submit">
                                    <i class="fas fa-save"></i>
                                    Enregistrer le producteur
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        function closeProducerModal() {
            const modal = document.getElementById('addProducerModal');
            if (modal) {
                modal.style.display = 'none';
                // Réinitialiser le formulaire pour permettre l'ajout d'un autre producteur
                const form = document.getElementById('addProducerForm');
                if (form) {
                    form.reset();
                }
            }
        }

        function saveProducer(event) {
            event.preventDefault();
            
            // Générer un code unique pour le producteur (basé sur timestamp + random)
            // Utiliser une combinaison timestamp + random pour garantir l'unicité même avec plusieurs ajouts rapides
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 8).toUpperCase();
            const producerCode = 'PROD-' + timestamp.toString(36).toUpperCase() + '-' + random;
            
            // Générer un ID unique (timestamp + microsecondes si possible)
            const uniqueId = timestamp + '-' + Math.random().toString(36).substr(2, 9);
            
            const producerData = {
                id: uniqueId, // ID unique pour éviter les collisions
                code: producerCode, // Code unique pour que le producteur puisse s'identifier
                name: document.getElementById('producerName').value,
                region: document.getElementById('producerRegion').value,
                phone: document.getElementById('producerPhone').value || '',
                email: document.getElementById('producerEmail').value || '',
                notes: document.getElementById('producerNotes').value || '',
                createdAt: new Date().toISOString(),
                professionalId: 'current_professional' // ID du professionnel actuel
            };

            // Récupérer la liste des producteurs du professionnel (pas de limite)
            const professionalProducers = JSON.parse(localStorage.getItem('professional_producers')) || [];
            
            // Vérifier que le code n'existe pas déjà (très peu probable mais sécurité)
            const codeExists = professionalProducers.some(p => p.code === producerCode);
            if (codeExists) {
                // Si le code existe (très rare), régénérer
                const newRandom = Math.random().toString(36).substr(2, 8).toUpperCase();
                producerData.code = 'PROD-' + timestamp.toString(36).toUpperCase() + '-' + newRandom;
            }
            
            // Ajouter le nouveau producteur (aucune limite)
            professionalProducers.push(producerData);
            localStorage.setItem('professional_producers', JSON.stringify(professionalProducers));

            // Fermer le modal
            closeProducerModal();
            
            // Afficher le code du producteur dans une modal
            showProducerCode(producerData);
            
            // Recharger les données du dashboard
            loadDashboardData();
            
            // Afficher une notification de succès
            showNotification(`✅ Producteur "${producerData.name}" ajouté avec succès ! (Total: ${professionalProducers.length})`, 'success');
        }

        function showProducerCode(producer) {
            const modal = document.createElement('div');
            modal.id = 'producerCodeModal';
            modal.className = 'producer-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>
                            <i class="fas fa-check-circle"></i>
                            Producteur créé avec succès !
                        </h2>
                        <button class="modal-close" onclick="closeProducerCodeModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; padding: 2rem 0;">
                            <p style="font-size: 1.1rem; margin-bottom: 1.5rem; color: #2c3e50;">
                                <strong>${producer.name}</strong> a été ajouté avec succès !
                            </p>
                            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                                <p style="margin: 0 0 0.5rem 0; color: #6c757d; font-size: 0.9rem;">Code du producteur :</p>
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px solid #667eea;">
                                    <code style="font-size: 1.5rem; font-weight: bold; color: #667eea; letter-spacing: 2px;">${producer.code}</code>
                                </div>
                            </div>
                            <p style="color: #6c757d; font-size: 0.9rem; margin-bottom: 1rem;">
                                <i class="fas fa-info-circle"></i>
                                Partagez ce code avec le producteur. Il devra l'entrer dans son interface pour que ses données soient automatiquement associées à votre compte.
                            </p>
                            <button class="btn-submit" onclick="copyProducerCode('${producer.code}')" style="width: 100%;">
                                <i class="fas fa-copy"></i>
                                Copier le code
                            </button>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeProducerCodeModal()">
                            <i class="fas fa-check"></i>
                            Compris
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        function closeProducerCodeModal() {
            const modal = document.getElementById('producerCodeModal');
            if (modal) {
                modal.remove();
            }
        }

        function copyProducerCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showNotification('✅ Code copié dans le presse-papiers !', 'success');
            }).catch(() => {
                // Fallback pour les navigateurs qui ne supportent pas clipboard API
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('✅ Code copié dans le presse-papiers !', 'success');
            });
        }

        function showNotification(message, type = 'info') {
            // Créer une notification simple
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#2E8B57' : type === 'error' ? '#dc3545' : '#667eea'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function viewProducer(id) {
            // Rediriger vers la page de détails dédiée
            window.location.href = `producteur-details.html?id=${id}`;
        }


        function exportData() {
            alert('Fonctionnalité d\'export en cours de développement');
        }

        // Fonction pour calculer les estimations de production
        async function calculateProductionEstimates() {
            const estimateBtn = document.getElementById('estimateBtn');
            const estimatesDiv = document.getElementById('productionEstimates');
            const placeholderDiv = document.getElementById('estimatesPlaceholder');
            
            // Afficher un indicateur de chargement
            estimateBtn.disabled = true;
            estimateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="btn-text">Calcul en cours...</span>';
            
            // Récupérer les producteurs et leurs données
            const professionalProducers = JSON.parse(localStorage.getItem('professional_producers')) || [];
            const allProducerData = JSON.parse(localStorage.getItem('all_producer_submissions')) || {};
            
            if (professionalProducers.length === 0) {
                alert('Aucun producteur enregistré. Veuillez d\'abord ajouter des producteurs.');
                estimateBtn.disabled = false;
                estimateBtn.innerHTML = '<i class="fas fa-calculator"></i> <span class="btn-text">Calculer les estimations</span>';
                return;
            }
            
            // Calculer les estimations pour chaque producteur
            const estimates = [];
            let totalEstimatedProduction = 0;
            let producersWithData = 0;
            
            for (const producer of professionalProducers) {
                const submissions = allProducerData[producer.id] || [];
                
                if (submissions.length === 0) {
                    // Pas de données, estimation basée sur des moyennes
                    estimates.push({
                        producer: producer,
                        estimatedProduction: null,
                        method: 'Aucune donnée disponible',
                        confidence: 0,
                        details: 'Aucune soumission de données pour ce producteur'
                    });
                    continue;
                }
                
                producersWithData++;
                
                // Prendre la dernière soumission comme base
                const latestSubmission = submissions[submissions.length - 1];
                
                // Calculer une estimation basée sur les données historiques
                let historicalEstimate = 0;
                let historicalCount = 0;
                
                submissions.forEach(sub => {
                    if (sub.production_reelle) {
                        historicalEstimate += parseFloat(sub.production_reelle) || 0;
                        historicalCount++;
                    }
                });
                
                const avgHistoricalProduction = historicalCount > 0 ? historicalEstimate / historicalCount : 0;
                
                // Essayer d'utiliser le modèle XGBoost pour une estimation plus précise
                let mlEstimate = null;
                let mlConfidence = 0;
                
                try {
                    const predictionData = {
                        age_verger: parseFloat(latestSubmission.age_verger) || 15,
                        agroforest: latestSubmission.agroforest || 'Non',
                        engrais: latestSubmission.engrais || 'Oui',
                        fumier: latestSubmission.fumier || 'Non',
                        maladie: latestSubmission.maladie || 'Non',
                        herbicide: latestSubmission.herbicide || 'Non',
                        insecticide: latestSubmission.insecticide || 'Non',
                        fongicide: latestSubmission.fongicide || 'Non',
                        cout_prod: parseFloat(latestSubmission.cout_prod) || 450000,
                        prix_a: (parseFloat(latestSubmission.prix_a) || 1000) * 1000, // Conversion en FCFA/tonne
                        region: latestSubmission.region || 'Indenie-Djuablin',
                        pluviometrie: latestSubmission.pluviometrie || 'Normale',
                        sexe: latestSubmission.sexe || 'M',
                        competences: latestSubmission.competences || 'Moyennes'
                    };
                    
                    const response = await fetch('http://localhost:5000/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(predictionData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.prediction) {
                            // Convertir de t/ha à kg (estimation pour 1 ha)
                            mlEstimate = result.prediction.productivity_t_ha * 1000; // kg/ha
                            mlConfidence = result.prediction.confidence || 85;
                        }
                    }
                } catch (error) {
                    console.log('API non disponible, utilisation de l\'estimation historique');
                }
                
                // Utiliser l'estimation ML si disponible, sinon l'historique
                const finalEstimate = mlEstimate || avgHistoricalProduction;
                const confidence = mlEstimate ? mlConfidence : (historicalCount > 1 ? 75 : 60);
                
                // Ajuster selon la tendance si on a plusieurs soumissions
                let trendFactor = 1.0;
                if (submissions.length >= 2) {
                    const recent = parseFloat(submissions[submissions.length - 1].production_reelle) || 0;
                    const previous = parseFloat(submissions[submissions.length - 2].production_reelle) || 0;
                    if (previous > 0) {
                        trendFactor = 1 + ((recent - previous) / previous) * 0.3; // Facteur de tendance modéré
                    }
                }
                
                const adjustedEstimate = finalEstimate * trendFactor;
                totalEstimatedProduction += adjustedEstimate;
                
                estimates.push({
                    producer: producer,
                    estimatedProduction: Math.round(adjustedEstimate),
                    method: mlEstimate ? 'Modèle XGBoost' : 'Moyenne historique',
                    confidence: Math.round(confidence),
                    details: `Basé sur ${submissions.length} soumission${submissions.length > 1 ? 's' : ''}${mlEstimate ? ' (IA)' : ' (historique)'}`,
                    historicalAvg: Math.round(avgHistoricalProduction),
                    trend: trendFactor > 1.05 ? '↗️ Croissance' : trendFactor < 0.95 ? '↘️ Baisse' : '➡️ Stable'
                });
            }
            
            // Afficher les résultats
            displayProductionEstimates(estimates, totalEstimatedProduction, producersWithData);
            
            // Réactiver le bouton
            estimateBtn.disabled = false;
            estimateBtn.innerHTML = '<i class="fas fa-calculator"></i> <span class="btn-text">Recalculer les estimations</span>';
        }
        
        function displayProductionEstimates(estimates, totalEstimated, producersWithData) {
            const estimatesDiv = document.getElementById('productionEstimates');
            const placeholderDiv = document.getElementById('estimatesPlaceholder');
            
            // Masquer le placeholder
            placeholderDiv.style.display = 'none';
            
            // Créer le HTML des estimations
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-chart-line"></i>
                        Estimation Globale
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem;">
                                ${totalEstimated.toLocaleString()} kg
                            </div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">Production estimée totale</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem;">
                                ${producersWithData}
                            </div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">Producteurs avec données</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem;">
                                ${producersWithData > 0 ? Math.round(totalEstimated / producersWithData) : 0} kg
                            </div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">Moyenne par producteur</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
            `;
            
            estimates.forEach(estimate => {
                const hasEstimate = estimate.estimatedProduction !== null;
                
                html += `
                    <div class="producer-card" style="border: 2px solid ${hasEstimate ? '#2E8B57' : '#e9ecef'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">${estimate.producer.name}</h3>
                            ${hasEstimate ? `<span style="background: #2E8B57; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                ${estimate.estimatedProduction.toLocaleString()} kg
                            </span>` : '<span style="color: #6c757d; font-size: 0.85rem;">Pas de données</span>'}
                        </div>
                        
                        ${hasEstimate ? `
                            <div class="producer-info" style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: #2c3e50;">
                                        <i class="fas fa-brain" style="color: #667eea;"></i>
                                        Méthode:
                                    </span>
                                    <span style="color: #667eea; font-weight: 600;">${estimate.method}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: #2c3e50;">
                                        <i class="fas fa-check-circle" style="color: #28a745;"></i>
                                        Confiance:
                                    </span>
                                    <span style="color: #28a745; font-weight: 600;">${estimate.confidence}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: #2c3e50;">
                                        <i class="fas fa-chart-line" style="color: #ffc107;"></i>
                                        Tendance:
                                    </span>
                                    <span style="color: #ffc107; font-weight: 600;">${estimate.trend}</span>
                                </div>
                                ${estimate.historicalAvg ? `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                                    <span style="font-weight: 600; color: #2c3e50;">
                                        <i class="fas fa-history" style="color: #6c757d;"></i>
                                        Moyenne historique:
                                    </span>
                                    <span style="color: #6c757d; font-weight: 600;">${estimate.historicalAvg.toLocaleString()} kg</span>
                                </div>
                                ` : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: #6c757d; padding-top: 0.75rem; border-top: 1px solid #e9ecef;">
                                <i class="fas fa-info-circle"></i>
                                ${estimate.details}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 1.5rem; color: #6c757d;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                <p style="margin: 0;">${estimate.details}</p>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Demandez au producteur de soumettre ses données pour obtenir une estimation.</p>
                            </div>
                        `}
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                            <a href="producteur-details.html?id=${estimate.producer.id}" style="color: #667eea; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-eye"></i>
                                Voir les détails
                            </a>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            estimatesDiv.innerHTML = html;
            estimatesDiv.style.display = 'block';
        }

        // Fonction pour analyser les conseils donnés
        function loadAdviceAnalysis() {
            const analysisBtn = document.getElementById('adviceAnalysisBtn');
            const analysisDiv = document.getElementById('adviceAnalysis');
            const placeholderDiv = document.getElementById('advicePlaceholder');
            
            // Afficher un indicateur de chargement
            analysisBtn.disabled = true;
            analysisBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="btn-text">Analyse en cours...</span>';
            
            // Récupérer les producteurs
            const professionalProducers = JSON.parse(localStorage.getItem('professional_producers')) || [];
            const adviceTracking = JSON.parse(localStorage.getItem('advice_tracking') || '{}');
            
            if (professionalProducers.length === 0) {
                alert('Aucun producteur enregistré.');
                analysisBtn.disabled = false;
                analysisBtn.innerHTML = '<i class="fas fa-chart-bar"></i> <span class="btn-text">Analyser les conseils</span>';
                return;
            }
            
            // Compter les conseils par catégorie et type
            const adviceStats = {
                byCategory: {},
                byType: {},
                bySource: {},
                byProducer: {},
                mostFrequent: []
            };
            
            let totalAdvices = 0;
            
            professionalProducers.forEach(producer => {
                const producerAdvices = adviceTracking[producer.id] || [];
                totalAdvices += producerAdvices.length;
                
                if (producerAdvices.length > 0) {
                    adviceStats.byProducer[producer.id] = {
                        name: producer.name,
                        count: producerAdvices.length,
                        categories: {},
                        types: {}
                    };
                }
                
                producerAdvices.forEach(advice => {
                    const category = advice.category || 'Général';
                    const type = advice.type || 'Autre';
                    const source = advice.source || 'inconnu';
                    
                    // Par catégorie
                    adviceStats.byCategory[category] = (adviceStats.byCategory[category] || 0) + 1;
                    
                    // Par type
                    adviceStats.byType[type] = (adviceStats.byType[type] || 0) + 1;
                    
                    // Par source
                    adviceStats.bySource[source] = (adviceStats.bySource[source] || 0) + 1;
                    
                    // Par producteur
                    if (adviceStats.byProducer[producer.id]) {
                        adviceStats.byProducer[producer.id].categories[category] = 
                            (adviceStats.byProducer[producer.id].categories[category] || 0) + 1;
                        adviceStats.byProducer[producer.id].types[type] = 
                            (adviceStats.byProducer[producer.id].types[type] || 0) + 1;
                    }
                });
            });
            
            // Créer la liste des conseils les plus fréquents
            Object.entries(adviceStats.byType).forEach(([type, count]) => {
                adviceStats.mostFrequent.push({ type, count });
            });
            adviceStats.mostFrequent.sort((a, b) => b.count - a.count);
            
            // Afficher les résultats
            displayAdviceAnalysis(adviceStats, totalAdvices, professionalProducers.length);
            
            // Réactiver le bouton
            analysisBtn.disabled = false;
            analysisBtn.innerHTML = '<i class="fas fa-chart-bar"></i> <span class="btn-text">Actualiser l\'analyse</span>';
        }
        
        function displayAdviceAnalysis(stats, totalAdvices, totalProducers) {
            const analysisDiv = document.getElementById('adviceAnalysis');
            const placeholderDiv = document.getElementById('advicePlaceholder');
            
            // Masquer le placeholder
            placeholderDiv.style.display = 'none';
            
            if (totalAdvices === 0) {
                analysisDiv.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6c757d;">
                        <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Aucun conseil enregistré</h3>
                        <p>Les conseils seront enregistrés automatiquement lorsque vos producteurs consulteront les pages de conseils, l'assistant IA, ou les prédictions.</p>
                    </div>
                `;
                analysisDiv.style.display = 'block';
                return;
            }
            
            // Créer le HTML de l'analyse
            let html = `
                <div style="background: linear-gradient(135deg, #2E8B57 0%, #3CB371 100%); color: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-chart-pie"></i>
                        Vue d'Ensemble
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem;">
                                ${totalAdvices}
                            </div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">Conseils donnés au total</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem;">
                                ${Object.keys(stats.byProducer).length}
                            </div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">Producteurs ayant consulté</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem;">
                                ${Object.keys(stats.byCategory).length}
                            </div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">Catégories différentes</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem;">
                                ${Object.keys(stats.byProducer).length > 0 ? Math.round(totalAdvices / Object.keys(stats.byProducer).length) : 0}
                            </div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">Moyenne par producteur</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Conseils les plus fréquents -->
                    <div class="chart-card">
                        <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-trophy" style="color: #FFD700;"></i>
                            Top 10 des Conseils
                        </h3>
                        <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            // Afficher le top 10
            stats.mostFrequent.slice(0, 10).forEach((item, index) => {
                const percentage = totalAdvices > 0 ? Math.round((item.count / totalAdvices) * 100) : 0;
                html += `
                    <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid ${index < 3 ? '#2E8B57' : '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600; color: #2c3e50;">
                                ${index + 1}. ${item.type}
                            </span>
                            <span style="background: ${index < 3 ? '#2E8B57' : '#667eea'}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                ${item.count} fois
                            </span>
                        </div>
                        <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 0.5rem;">
                            <div style="background: ${index < 3 ? '#2E8B57' : '#667eea'}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">${percentage}% du total</div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <!-- Par catégorie -->
                    <div class="chart-card">
                        <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-tags" style="color: #667eea;"></i>
                            Par Catégorie
                        </h3>
                        <canvas id="adviceCategoryChart"></canvas>
                    </div>
                </div>
                
                <!-- Par source -->
                <div class="chart-card" style="margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-map" style="color: #ffc107;"></i>
                        Par Source de Conseil
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            `;
            
            const sourceLabels = {
                'prediction': 'Prédictions',
                'conseils': 'Conseils Agroécologiques',
                'assistant': 'Assistant IA',
                'score-ecologique': 'Score Écologique'
            };
            
            Object.entries(stats.bySource).sort((a, b) => b[1] - a[1]).forEach(([source, count]) => {
                const percentage = totalAdvices > 0 ? Math.round((count / totalAdvices) * 100) : 0;
                html += `
                    <div style="padding: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #2c3e50; margin-bottom: 0.5rem;">
                            ${count}
                        </div>
                        <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 0.25rem;">
                            ${sourceLabels[source] || source}
                        </div>
                        <div style="font-size: 0.75rem; color: #667eea; font-weight: 600;">
                            ${percentage}%
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <!-- Par producteur -->
                <div class="chart-card">
                    <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-users" style="color: #28a745;"></i>
                        Conseils Consultés par Producteur
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
            `;
            
            Object.values(stats.byProducer).sort((a, b) => b.count - a.count).forEach(producer => {
                const topCategory = Object.entries(producer.categories).sort((a, b) => b[1] - a[1])[0];
                const topType = Object.entries(producer.types).sort((a, b) => b[1] - a[1])[0];
                
                html += `
                    <div class="producer-card" style="border: 2px solid #e9ecef;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #2c3e50;">${producer.name}</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-weight: 600; color: #2c3e50;">
                                <i class="fas fa-lightbulb" style="color: #ffc107;"></i>
                                Total:
                            </span>
                            <span style="font-size: 1.25rem; font-weight: 700; color: #667eea;">
                                ${producer.count}
                            </span>
                        </div>
                        ${topCategory ? `
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem;">
                            <i class="fas fa-tag" style="color: #2E8B57;"></i>
                            Catégorie la plus consultée: <strong>${topCategory[0]}</strong> (${topCategory[1]} fois)
                        </div>
                        ` : ''}
                        ${topType ? `
                        <div style="font-size: 0.85rem; color: #6c757d;">
                            <i class="fas fa-star" style="color: #FFD700;"></i>
                            Type le plus consulté: <strong>${topType[0]}</strong> (${topType[1]} fois)
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            analysisDiv.innerHTML = html;
            analysisDiv.style.display = 'block';
            
            // Créer le graphique par catégorie
            setTimeout(() => {
                const ctx = document.getElementById('adviceCategoryChart');
                if (ctx) {
                    new Chart(ctx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(stats.byCategory),
                            datasets: [{
                                data: Object.values(stats.byCategory),
                                backgroundColor: [
                                    '#2E8B57', '#3CB371', '#28a745', '#667eea', '#764ba2',
                                    '#FFD700', '#FFA500', '#ffc107', '#dc3545', '#17a2b8'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }, 100);
        }
    </script>
</body>
</html>

